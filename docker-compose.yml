services:
  postgres:
    image: postgres:16-alpine
    container_name: postgres
    environment:
      POSTGRES_USER: auth
      POSTGRES_PASSWORD: authpass
      POSTGRES_DB: authdb
    volumes:
      - pgdata:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U auth -d authdb"]
      interval: 5s
      timeout: 5s
      retries: 5
    ports:
      - "5432:5432"

  log:
    build: ./video-stream-log
    container_name: log
    ports:
      - "2279:2279"
    depends_on:
      postgres:
        condition: service_healthy

  auth:
    build: ./video-stream-auth
    container_name: auth
    ports:
      - "2278:2278"
    environment:
      POSTGRES_HOST: postgres
      POSTGRES_USER: auth
      POSTGRES_PASSWORD: authpass
      POSTGRES_DB: authdb
      POSTGRES_PORT: 5432
    depends_on:
      postgres:
        condition: service_healthy
  channels:
    build: ./video-stream-channels
    container_name: channels
    ports:
      - "2276:2276"
    depends_on:
      - auth

  viewers:
    build: ./video-stream-viewers
    container_name: viewers
    ports:
      - "2277:2277"
    depends_on:
      - channels

  rtmp:
    build: ./video-stream-rtmp
    container_name: rtmp
    ports:
      - "1935:1935"
      - "8080:8080"
    depends_on:
      - viewers
    volumes:
      - ./hls:/var/www/hls

  irc:
    image: ghcr.io/ergochat/ergo:stable
    container_name: irc
    command: ["--conf", "/ircd/ergo.yaml"]
    ports:
      - "6667:6667"   # plaintext IRC
      - "6697:6697"   # TLS IRC
    volumes:
      - ./video-stream-irc/ergo:/ircd
      - ./video-stream-irc/tls:/ircd/tls:ro
    restart: unless-stopped

  ui:
    build: ./video-stream-ui
    container_name: ui
    depends_on:
      - rtmp
    ports:
    - "3000:3000"

volumes:
  pgdata:
